name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build binaries
        run: bun run build:binaries

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist-binaries/hogman-darwin-arm64
            dist-binaries/hogman-darwin-x64
            dist-binaries/hogman-linux-arm64
            dist-binaries/hogman-linux-x64
            dist-binaries/checksums.txt
          body: |
            ## Install

            **macOS (Apple Silicon):**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hogman-darwin-arm64 -o /usr/local/bin/hogman
            chmod +x /usr/local/bin/hogman
            ```

            **macOS (Intel):**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hogman-darwin-x64 -o /usr/local/bin/hogman
            chmod +x /usr/local/bin/hogman
            ```

            **Linux (x64):**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/hogman-linux-x64 -o /usr/local/bin/hogman
            chmod +x /usr/local/bin/hogman
            ```

            ## Quick start
            ```bash
            hogman accounts add default --api-key phx_...
            hogman projects list
            hogman projects use <id>
            hogman query "SELECT event, count() FROM events GROUP BY event ORDER BY count() DESC LIMIT 20"
            ```

            See the [README](https://github.com/${{ github.repository }}#readme) for full documentation.
